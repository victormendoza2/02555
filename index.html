<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Registro Plantaciones Forestales BPS ‚Äî con Titulares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Dise√±o */
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    body { display:flex; }
    #panel { width: 360px; min-width: 300px; max-width: 420px; background: #f7f7f7; display:flex; flex-direction:column; border-right:1px solid #e6e6e6; padding-bottom:8px; box-sizing:border-box; }
    header { background: linear-gradient(90deg,#0b6b2b,#008000); color:white; padding:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    header h1 { margin:0; font-size:15px; }
    header p { margin:6px 0 0 0; font-size:12px; opacity:0.95; }

    .toolbar { display:flex; gap:6px; padding:10px; background:#fff; align-items:center; border-bottom:1px solid #e6e6e6; flex-wrap:wrap; }
    .toolbar button, .toolbar select, .toolbar input[type="file"] {
      background:white; border:1px solid #d0d0d0; padding:8px 10px; border-radius:8px;
      cursor:pointer; display:flex; gap:6px; align-items:center; font-size:13px;
    }
    .toolbar button.primary { background:#0b6b2b; color:white; border-color:#0b6b2b; }
    .controls { padding:10px; display:flex; flex-direction:column; gap:8px; }

    .infoBox { background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); font-size:13px; text-align:left; }
    .small { font-size:12px; color:#444; }
    #map { flex:1; height:100vh; }

    .legend { display:flex; gap:8px; align-items:center; font-size:12px; margin-top:6px; flex-wrap:wrap; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,0.1); }
    .label { background: rgba(255,255,255,0.95); padding:4px 6px; border-radius:6px; border:1px solid #ddd; font-size:12px; font-weight:600; }

    /* estilo para etiqueta de titular */
    .etiqueta-predio {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.25);
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    /* status */
    #status-msg {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(11,107,43,0.95); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0; transition: opacity 0.35s ease-in-out; z-index: 99999;
    }
    #status-msg.show { opacity: 1; }

    /* tabla */
    #results { padding:10px; overflow:auto; max-height:40vh; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #e6e6e6; padding:6px; text-align:left; }
    th { background:#f0f0f0; font-weight:700; }

    .downloads { display:flex; gap:6px; flex-wrap:wrap; }
    .downloads button { flex:1; }
  </style>
</head>
<body>

  <div id="panel">
    <header>
      <h1>üå≥ Registro Plantaciones Forestales BPS ‚Äî Victor E. Mendoza A.</h1>
      <p>Especialista en Gesti√≥n del Catastro Forestal - BPS</p>
    </header>

    <div class="toolbar" style="justify-content:flex-start;">
      <button id="btn-gps"><i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS</button>
      <button id="btn-gps-vertex" class="primary"><i class="fa-solid fa-crosshairs"></i>&nbsp;Agregar v√©rtice GPS</button>
    </div>

    <div class="controls">
      <div class="infoBox">
        <div class="small">Cargar Excel / CSV con coordenadas</div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <label style="flex:1;">
            <input id="file-input" type="file" accept=".csv,.xlsx" style="display:none"/>
            <button id="btn-upload" style="width:100%;"><i class="fa-solid fa-file-import"></i>&nbsp;Cargar CSV / Excel</button>
          </label>
        </div>

        <div style="display:flex;gap:6px;margin-top:8px;align-items:center;">
          <label class="small">CRS entrada:</label>
          <select id="crs-select" style="flex:1;">
            <option value="4326">EPSG:4326 (Lat/Lon)</option>
            <option value="32717">EPSG:32717 (UTM 17S)</option>
            <option value="32718" selected>EPSG:32718 (UTM 18S)</option>
            <option value="32719">EPSG:32719 (UTM 19S)</option>
          </select>
        </div>

        <div class="legend" style="margin-top:10px;">
          <div><span class="dot" style="background:#2ecc71"></span><small>&nbsp;&lt;5m</small></div>
          <div><span class="dot" style="background:#f1c40f"></span><small>&nbsp;5-7m</small></div>
          <div><span class="dot" style="background:#e74c3c"></span><small>&nbsp;&gt;7m</small></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:6px;">
          <button id="btn-download-input-geo" title="Descargar pol√≠gono de entrada"><i class="fa-solid fa-download"></i>&nbsp;Descargar pol√≠gono</button>
          <button id="btn-clear"><i class="fa-solid fa-trash"></i>&nbsp;Limpiar</button>
        </div>

        <div style="margin-top:8px;" class="small">
          <div id="info-precision">üì° Precisi√≥n: -- m</div>
        </div>
      </div>

      <div class="infoBox" style="display:flex;flex-direction:column;gap:6px;">
        <div class="small"><b>Resultados MIDAGRI (Predio Rural)</b></div>
        <div style="display:flex;gap:6px;">
          <button id="btn-download-midagri-geo" style="flex:1;"><i class="fa-solid fa-map"></i>&nbsp;GeoJSON</button>
          <button id="btn-download-midagri-csv" style="flex:1;"><i class="fa-solid fa-file-csv"></i>&nbsp;CSV</button>
        </div>
        <div style="margin-top:6px;">
          <button id="btn-zoom-intersect" style="width:100%;"><i class="fa-solid fa-search-location"></i>&nbsp;Zoom a intersectados</button>
        </div>
      </div>

      <div id="results" class="infoBox">
        <div class="small"><b>Predios intersectados</b></div>
        <div id="tabla-inter" style="margin-top:8px;">No hay resultados.</div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <div id="status-msg" role="status" aria-live="polite"></div>

  <!-- Librer√≠as -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>

  <script>
  // ---------- UTIL UI ----------
  function showStatus(msg, color="#0b6b2b", timeout=2500){
    const el = document.getElementById('status-msg');
    el.style.background = color;
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(()=> el.classList.remove('show'), timeout);
  }

  // ---------- PROJS ----------
  proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32718","+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32719","+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs");

  // ---------- MAP ----------
  const map = L.map('map', { zoomControl:true }).setView([-7.2, -78.5], 8);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{attribution:'¬© Google'});
  L.control.layers({"OSM":osm,"Google Sat√©lite":googleSat}).addTo(map);

  // ---------- CAPAS ----------
  const gpsLayer = new L.FeatureGroup().addTo(map);
  const uploadedLayer = new L.FeatureGroup().addTo(map);
  const drawnItems = new L.FeatureGroup().addTo(map);
  const trackLayer = L.polyline([], { color:'red', weight:3 }).addTo(map);
  const intersectLayer = new L.FeatureGroup().addTo(map);
  const titularLabelsLayer = new L.FeatureGroup().addTo(map); // para manejar etiquetas de titulares

  let gpsMarker=null, accuracyCircle=null, watchId=null;
  let gpsVertices=[], trackCoords=[];
  let activePolygon=null, lastTrackPoint=null;
  const infoPrecision=document.getElementById('info-precision');

  // ---------- Datos ----------
  let intersectFeatures = []; // array de GeoJSON features from MIDAGRI
  let inputPolygonFeature = null; // GeoJSON polygon (lon/lat order), with property area_ha
  let propietariosMap = {}; // mapa num_predio_normalizado -> nombre titular

  // ---------- Draw control ----------
  const drawControl = new L.Control.Draw({
    draw:{ polygon:{allowIntersection:false,showArea:true,shapeOptions:{color:'#0b6b2b'}}, marker:true, polyline:false, rectangle:false, circle:false, circlemarker:false },
    edit:{ featureGroup:drawnItems, edit:true, remove:true }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED,e=>{
    drawnItems.addLayer(e.layer);
    if(e.layer instanceof L.Polygon){ addOrUpdateLabel(e.layer); try { checkIntersection(e.layer.toGeoJSON()); } catch(e){} }
    saveSession();
  });
  map.on(L.Draw.Event.EDITED,e=>{
    e.layers.eachLayer(l=>{ if(l instanceof L.Polygon){ addOrUpdateLabel(l); try { checkIntersection(l.toGeoJSON()); } catch(e){} } });
    saveSession();
  });
  map.on(L.Draw.Event.DELETED,()=>{ clearAllLabels(); saveSession(); });

  // ---------- Label area ----------
  function addOrUpdateLabel(layer){
    try {
      const gj = layer.toGeoJSON();
      const area_m2 = turf.area(gj);
      const area_ha = parseFloat((area_m2/10000).toFixed(2));
      const center = turf.centerOfMass(gj).geometry.coordinates; // [lon,lat]
      if(layer._label) map.removeLayer(layer._label);
      layer._label = L.marker([center[1], center[0]], { icon: L.divIcon({ className:'label', html:`${area_ha} ha`}) }).addTo(map);
    } catch(e){}
  }

  function clearAllLabels(){
    // elimina labels de drawnItems y de titulares
    map.eachLayer(l => { if(l instanceof L.Marker && l.options.icon?.options?.className === 'label') map.removeLayer(l); });
    drawnItems.eachLayer(l => { if(l._label){ map.removeLayer(l._label); delete l._label; }});
    titularLabelsLayer.clearLayers();
  }

  // ---------- GPS ----------
  document.getElementById('btn-gps').onclick=()=>{
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS'; showStatus('GPS detenido','#d9534f'); return; }
    if(!navigator.geolocation) return alert('GPS no disponible.');
    document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-stop"></i>&nbsp;Detener GPS';
    showStatus('GPS activado');
    watchId = navigator.geolocation.watchPosition(p=>{
      const lat=p.coords.latitude, lng=p.coords.longitude, acc=p.coords.accuracy;
      if(!gpsMarker) gpsMarker = L.circleMarker([lat,lng],{radius:8,color:'#ff5722',fillColor:'#ff5722',fillOpacity:1}).addTo(map);
      gpsMarker.setLatLng([lat,lng]); gpsMarker.accuracy=acc;
      if(accuracyCircle) map.removeLayer(accuracyCircle);
      accuracyCircle = L.circle([lat,lng],{radius:acc,color:colorForPrecision(acc),weight:1,fillOpacity:0.08}).addTo(map);
      if(acc<=5) gpsMarker.setStyle({color:'#2ecc71',fillColor:'#2ecc71'}); else if(acc<=7) gpsMarker.setStyle({color:'#f1c40f',fillColor:'#f1c40f'}); else gpsMarker.setStyle({color:'#e74c3c',fillColor:'#e74c3c'});
      const current=[lat,lng];
      if(!lastTrackPoint || distanceMeters(lastTrackPoint,current)>10){ trackCoords.push(current); trackLayer.setLatLngs(trackCoords); lastTrackPoint=current; }
      infoPrecision.innerText=`üì° Precisi√≥n: ${acc.toFixed(1)} m`;
      saveSession();
    }, err=>alert("Error GPS: "+err.message), { enableHighAccuracy:true });
  };
  function colorForPrecision(acc){ if(acc<=5) return '#2ecc71'; if(acc<=7) return '#f1c40f'; return '#e74c3c'; }
  function distanceMeters(a,b){ const R=6371000,rad=Math.PI/180; const dLat=(b[0]-a[0])*rad,dLon=(b[1]-a[1])*rad; const lat1=a[0]*rad,lat2=b[0]*rad; const hav=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(hav)); }

  // ---------- Upload controls ----------
  document.getElementById('btn-upload').onclick = ()=> document.getElementById('file-input').click();
  document.getElementById('file-input').onchange = e => {
    const file = e.target.files[0]; if(!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    if(ext === 'csv') parseCSVLocal(file); else parseXLSXLocal(file);
  };

  // ---------- Parsers locales (opcional: si quieres cargar CSV/XLS desde tu PC) ----------
  function parseCSVLocal(file){
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      const rows = parsed.data;
      buildPropietariosMapFromRows(rows);
    };
    reader.readAsText(file, 'UTF-8');
  }
  function parseXLSXLocal(file){
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(e.target.result, { type:'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
      buildPropietariosMapFromRows(rows);
    };
    reader.readAsBinaryString(file);
  }

  // ---------- Cargar CSV desde repo (data/propietarios.csv) ----------
  // Se ejecuta al inicio para intentar cargar autom√°ticamente el CSV desde la carpeta data/
  (function loadPropietariosFromRepo(){
    const path = 'data/propietarios.csv'; // coloca aqu√≠ tu CSV en repo/data/propietarios.csv
    fetch(path).then(resp=>{
      if(!resp.ok) throw new Error('No se encontr√≥ propietarios.csv en data/');
      return resp.text();
    }).then(text=>{
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      buildPropietariosMapFromRows(parsed.data);
      showStatus('Propietarios cargados (data/propietarios.csv)');
    }).catch(err=>{
      console.warn('No se carg√≥ propietarios desde data/:', err.message);
      // no mostrar error cr√≠tico; el usuario puede subir localmente mediante el bot√≥n
    });
  })();

  // ---------- Construcci√≥n del mapa de propietarios ----------
  function buildPropietariosMapFromRows(rows){
    propietariosMap = {}; let count=0;
    rows.forEach(r => {
      // normalizar nombres de columnas posibles
      const num = r.num_predio ?? r.NUM_PREDIO ?? r['num_predio'] ?? r['num predio'] ?? r.num ?? r.numero ?? r['NRO_PREDIO'] ?? r['numpredio'];
      const nombre = r.nombre ?? r.NOMBRE ?? r['Nombre'] ?? r['name'] ?? r.titular ?? r.TITULAR ?? '';
      if(num == null) return;
      const n = normalizePredio(String(num));
      const nn = String(nombre || '').trim();
      if(n && nn) { propietariosMap[n] = nn; count++; }
    });
    console.log('Mapa propietarios:', propietariosMap);
    showStatus(`Mapa propietarios: ${count} registros`);
  }

  // Normalizaci√≥n: eliminar espacios, caracteres no num√©ricos y ceros a la izquierda
  function normalizePredio(s){
    if(!s && s !== 0) return '';
    let t = String(s).trim();
    // eliminar comillas, espacios, puntos, guiones y todo no num√©rico
    t = t.replace(/[^0-9]/g, '');
    // quitar ceros a la izquierda
    t = t.replace(/^0+/, '');
    return t;
  }

  // ---------- Handle uploaded coordinates -> pol√≠gono ----------
  function parseCSV(file, crs){
    Papa.parse(file, { header:true, skipEmptyLines:true, complete: r => {
      const rows = r.data;
      const arr = [];
      rows.forEach(row => {
        const lower = {}; Object.keys(row).forEach(k => lower[k.trim().toLowerCase()] = row[k]);
        const x = parseFloat(lower['este'] ?? lower['x'] ?? lower['lon'] ?? lower['longitud'] ?? lower['longitude'] ?? lower['e'] ?? Object.values(row)[0]);
        const y = parseFloat(lower['norte'] ?? lower['y'] ?? lower['lat'] ?? lower['latitud'] ?? lower['latitude'] ?? lower['n'] ?? Object.values(row)[1]);
        if(!isNaN(x) && !isNaN(y)) arr.push([x,y]);
      });
      handleRows(arr, crs, true);
    }});
  }
  function parseXLSX(file, crs){
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(e.target.result, { type:'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header:1, defval: "" });
      if(!data || data.length < 2) return showStatus('Archivo vac√≠o o sin datos','#d9534f');
      const headers = data[0].map(h => String(h).toLowerCase());
      const colE = headers.findIndex(h => h.includes('este') || h==='x' || h==='e' || h.includes('lon') || h.includes('long'));
      const colN = headers.findIndex(h => h.includes('norte') || h==='y' || h==='n' || h.includes('lat'));
      const coords = data.slice(1).map(r => {
        const vx = (colE >= 0) ? r[colE] : r[0];
        const vy = (colN >= 0) ? r[colN] : r[1];
        return [parseFloat(vx), parseFloat(vy)];
      }).filter(p => !isNaN(p[0]) && !isNaN(p[1]));
      handleRows(coords, crs, true);
    };
    reader.readAsBinaryString(file);
  }

  function handleRows(rows, crs, isArray=false){
    uploadedLayer.clearLayers(); intersectLayer.clearLayers(); titularLabelsLayer.clearLayers(); intersectFeatures = []; inputPolygonFeature = null; document.getElementById('tabla-inter').innerHTML = "Procesando...";
    const pointsLatLon = [];
    rows.forEach(r => {
      if(!r) return;
      let x = r[0], y = r[1];
      if(isNaN(x) || isNaN(y)) return;
      let lonLat;
      if(crs === '4326') lonLat = [ parseFloat(x), parseFloat(y) ];
      else {
        try { lonLat = proj4('EPSG:' + crs, 'EPSG:4326', [x, y]); } catch { lonLat = [x,y]; }
      }
      let lon = Number(lonLat[0]); let lat = Number(lonLat[1]);
      if(isNaN(lat) || isNaN(lon)) return;
      const dispLat = lat, dispLon = lon;
      pointsLatLon.push([dispLat, dispLon]);
      L.circleMarker([dispLat, dispLon], { radius:5, color:'#007bff', fillColor:'#007bff', fillOpacity:0.9 }).addTo(uploadedLayer);
    });

    if(pointsLatLon.length < 3){
      document.getElementById('tabla-inter').innerHTML = "<div class='small'>Se requieren al menos 3 coordenadas v√°lidas.</div>";
      showStatus('Se requieren al menos 3 coordenadas v√°lidas','#d9534f');
      return;
    }

    const first = pointsLatLon[0], last = pointsLatLon[pointsLatLon.length - 1];
    if(first[0] !== last[0] || first[1] !== last[1]) pointsLatLon.push(first);

    const poly = L.polygon(pointsLatLon, { color:'#0056b3', fillOpacity:0.15 }).addTo(uploadedLayer);
    addOrUpdateLabel(poly);

    const coordsLonLat = pointsLatLon.map(p => [p[1], p[0]]);
    if(coordsLonLat.length < 4) return;
    if(coordsLonLat[0][0] !== coordsLonLat[coordsLonLat.length-1][0] || coordsLonLat[0][1] !== coordsLonLat[coordsLonLat.length-1][1]) coordsLonLat.push(coordsLonLat[0]);

    const gj = {
      type: 'Feature',
      properties: {},
      geometry: { type: 'Polygon', coordinates: [ coordsLonLat ] }
    };
    try { gj.properties.area_ha = parseFloat((turf.area(gj) / 10000).toFixed(2)); } catch(e){ gj.properties.area_ha = 0; }
    inputPolygonFeature = gj;

    map.fitBounds(poly.getBounds().pad(0.12));
    try { checkIntersection(inputPolygonFeature); } catch(e){ console.error(e); showStatus('Error al consultar MIDAGRI','#d9534f'); }
    saveSession();
  }

  // ---------- MIDAGRI FeatureLayer ----------
  const MIDAGRI_LAYER_URL = 'https://georural.midagri.gob.pe/geoservicios/rest/services/public/Catastro_Rural/MapServer/0';
  const midagriLayer = L.esri.featureLayer({ url: MIDAGRI_LAYER_URL });

  // ---------- Intersection: pintar y etiquetar ----------
  function checkIntersection(geojsonFeature){
    try {
      if(!geojsonFeature) return;
      intersectLayer.clearLayers(); titularLabelsLayer.clearLayers(); intersectFeatures = []; document.getElementById('tabla-inter').innerHTML = "Consultando MIDAGRI...";

      // Consulta al servicio MIDAGRI con la geometr√≠a
      midagriLayer.query().intersects(geojsonFeature).run(function(error, featureCollection){
        if(error){
          console.error("MIDAGRI query error:", error);
          showStatus("Error al consultar Catastro Rural (MIDAGRI)", "#d9534f");
          document.getElementById('tabla-inter').innerHTML = "<div class='small'>Error al consultar MIDAGRI. Ver consola.</div>";
          return;
        }

        const features = (featureCollection && featureCollection.features) ? featureCollection.features : [];
        if(features.length === 0){
          showStatus("‚ùå No intersecta con predios del Catastro Rural.", "#d9534f");
          document.getElementById('tabla-inter').innerHTML = "<div class='small'>No hay predios intersectados.</div>";
          return;
        }

        intersectFeatures = features;

        // Pintar predios y preparar tabla/etiquetas
        features.forEach(f => {
          const layer = L.geoJSON(f, { style: { color:"#00a94f", weight:2, fillOpacity:0.25 } }).addTo(intersectLayer);
          const props = f.properties || {};
          const id = props.OBJECTID || props.ID || props.OBJECTID_1 || props.oid || "-";
          const area_ha = props.AREA ? (Number(props.AREA)/10000).toFixed(3) : (turf.area(f)/10000).toFixed(3);

          // Buscar num_predio en distintas claves comunes
          const possibleKeys = ['num_predio','NUM_PREDIO','NUM_PRED','NRO_PREDIO','numpredio','NUMERO','numero','codpredio','cod_predio','codigo'];
          let rawNum = null;
          for(const k of possibleKeys){
            if(props[k] !== undefined && props[k] !== null){
              rawNum = props[k];
              break;
            }
          }
          // Si no est√°, algunos registros usan NOMBRE o CODIGO ‚Äî intentar usar CODIGO si existe
          if(!rawNum && props.CODIGO) rawNum = props.CODIGO;

          // Normalizar y buscar titular
          const normalized = normalizePredio(String(rawNum || ''));
          const titular = propietariosMap[normalized] || null;

          // Popup con informaci√≥n (incluye titular si existe)
          let popup = `<div style="font-size:13px"><b>Predio Rural</b><br><b>ID:</b> ${id}<br><b>√Årea (ha):</b> ${area_ha}<br>`;
          const extras = ['DEPARTAMEN','DEPARTAMENTO','PROVINCIA','DISTRITO','NOMBRE','CODIGO','TITULAR','PROPietario','PROPIETARI'];
          extras.forEach(k => { if(props[k]) popup += `<b>${k}:</b> ${props[k]}<br>`; });
          if(titular) popup += `<b>Titular CSV:</b> ${titular}<br>`;
          popup += `</div>`;
          layer.bindPopup(popup);

          // Si encontramos titular, crear etiqueta en centroid y agregar a layer de etiquetas
          if(titular){
            try {
              const cent = turf.centroid(f).geometry.coordinates; // [lon, lat]
              const marker = L.marker([cent[1], cent[0]], {
                icon: L.divIcon({
                  className: 'etiqueta-predio',
                  html: escaparHTML(titular),
                  iconSize: [120, 24]
                })
              });
              titularLabelsLayer.addLayer(marker);
            } catch(e){ console.warn('Error creando etiqueta titular para feature', e); }
          }
        });

        // agregar capas si a√∫n no est√°n en mapa
        if(!map.hasLayer(intersectLayer)) intersectLayer.addTo(map);
        if(!map.hasLayer(titularLabelsLayer)) titularLabelsLayer.addTo(map);

        renderTable(features);
        showStatus(`‚úÖ Intersecta con ${features.length} predio(s).`, "#0b6b2b");
      });
    } catch(e){
      console.error(e);
      showStatus("Error en verificaci√≥n MIDAGRI","#d9534f");
    }
  }

  // escape simple para html en etiquetas
  function escaparHTML(str){
    return String(str).replace(/[&<>"']/g,function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]; });
  }

  // ---------- Render table ----------
  function renderTable(features){
    const div = document.getElementById('tabla-inter');
    if(!features || features.length === 0){ div.innerHTML = "<div class='small'>No hay predios intersectados.</div>"; return; }
    const allKeys = new Set();
    features.forEach(f => { Object.keys(f.properties || {}).forEach(k => allKeys.add(k)); });
    // asegurarnos columna TITULAR y NUM_PREDIO normalizada en tabla
    allKeys.add('TITULAR_CSV');
    allKeys.add('NUM_PREDIO_NORMAL');

    const keys = Array.from(allKeys);
    let html = "<table><thead><tr>";
    keys.forEach(k => html += `<th>${k}</th>`);
    html += "</tr></thead><tbody>";

    features.forEach(f => {
      const props = f.properties || {};
      // normalizar num_predio para la fila
      let rawNum = null;
      const possibleKeys = ['num_predio','NUM_PREDIO','NUM_PRED','NRO_PREDIO','numpredio','NUMERO','numero','codpredio','cod_predio','codigo'];
      for(const k of possibleKeys){ if(props[k] !== undefined && props[k] !== null){ rawNum = props[k]; break; } }
      if(!rawNum && props.CODIGO) rawNum = props.CODIGO;
      const normalized = normalizePredio(String(rawNum || ''));
      const titular = propietariosMap[normalized] || '';

      html += "<tr>";
      keys.forEach(k => {
        if(k === 'TITULAR_CSV') html += `<td>${titular}</td>`;
        else if(k === 'NUM_PREDIO_NORMAL') html += `<td>${normalized}</td>`;
        else html += `<td>${(props && props[k])? String(props[k]) : ''}</td>`;
      });
      html += "</tr>";
    });

    html += "</tbody></table>";
    div.innerHTML = html;
  }

  // ---------- Downloads ----------
  document.getElementById('btn-download-midagri-geo').onclick = () => {
    if(!intersectFeatures || intersectFeatures.length === 0){ showStatus('No hay predios para descargar','#d9534f'); return; }
    const fc = { type:'FeatureCollection', features: intersectFeatures };
    const blob = new Blob([JSON.stringify(fc)], { type:'application/geo+json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'predios_intersectados.geojson'; a.click(); URL.revokeObjectURL(url);
    showStatus('‚úÖ GeoJSON descargado');
  };

  document.getElementById('btn-download-midagri-csv').onclick = () => {
    if(!intersectFeatures || intersectFeatures.length === 0){ showStatus('No hay predios para descargar','#d9534f'); return; }
    const rows = intersectFeatures.map(f => {
      const p = f.properties || {};
      // normalizar
      let rawNum = null;
      const possibleKeys = ['num_predio','NUM_PREDIO','NUM_PRED','NRO_PREDIO','numpredio','NUMERO','numero','codpredio','cod_predio','codigo'];
      for(const k of possibleKeys){ if(p[k] !== undefined && p[k] !== null){ rawNum = p[k]; break; } }
      if(!rawNum && p.CODIGO) rawNum = p.CODIGO;
      const normalized = normalizePredio(String(rawNum || ''));
      const titular = propietariosMap[normalized] || p.TITULAR || p.NOMBRE || "";
      return {
        ID: p.OBJECTID || p.ID || p.OBJECTID_1 || "",
        NUM_PREDIO: rawNum || "",
        NUM_PREDIO_NORMAL: normalized,
        AREA_HA: p.AREA ? (Number(p.AREA)/10000).toFixed(3) : (turf.area(f)/10000).toFixed(3),
        DEPARTAMENTO: p.DEPARTAMEN || p.DEPARTAMENTO || "",
        PROVINCIA: p.PROVINCIA || "",
        DISTRITO: p.DISTRITO || "",
        TITULAR: titular
      };
    });
    const csv = Papa.unparse(rows);
    const blob = new Blob([csv], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'predios_intersectados.csv'; a.click(); URL.revokeObjectURL(url);
    showStatus('‚úÖ CSV descargado');
  };

  // ---------- Download input polygon ----------
  document.getElementById('btn-download-input-geo').onclick = () => {
    if(!inputPolygonFeature){ showStatus('No hay pol√≠gono de entrada','#d9534f'); return; }
    const gj = JSON.parse(JSON.stringify(inputPolygonFeature));
    gj.properties = gj.properties || {};
    gj.properties.area_ha = gj.properties.area_ha || parseFloat((turf.area(gj)/10000).toFixed(2));
    const blob = new Blob([JSON.stringify(gj)], { type:'application/geo+json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'poligono_entrada.geojson'; a.click(); URL.revokeObjectURL(url);
    showStatus('‚úÖ Pol√≠gono descargado');
  };

  // ---------- Zoom to intersect ----------
  document.getElementById('btn-zoom-intersect').onclick = () => {
    if(!intersectLayer || intersectLayer.getLayers().length === 0){ showStatus('No hay predios para hacer zoom','#d9534f'); return; }
    map.fitBounds(intersectLayer.getBounds().pad(0.15));
  };

  // ---------- Save / restore session ----------
  function saveSession(){
    const data = { drawn: drawnItems.toGeoJSON(), gps: gpsLayer.toGeoJSON(), uploaded: uploadedLayer.toGeoJSON(), track: trackCoords };
    localStorage.setItem("bps_sesion", JSON.stringify(data));
  }
  window.addEventListener("load", ()=>{
    const saved = localStorage.getItem("bps_sesion");
    if(saved && confirm("üîÑ ¬øDeseas restaurar tu √∫ltima sesi√≥n?")){
      const data = JSON.parse(saved);
      L.geoJSON(data.drawn, { onEachFeature:(f,l)=>{ drawnItems.addLayer(l); if(l instanceof L.Polygon) addOrUpdateLabel(l); }});
      L.geoJSON(data.gps, { onEachFeature:(f,l)=>{ gpsLayer.addLayer(l); }});
      L.geoJSON(data.uploaded, { onEachFeature:(f,l)=>{ uploadedLayer.addLayer(l); }});
      trackCoords = data.track || [];
      trackLayer.setLatLngs(trackCoords);
    }
  });

  // ---------- Clear ----------
  document.getElementById('btn-clear').onclick = () => {
    if(!confirm('¬øEliminar todo?')) return;
    gpsLayer.clearLayers(); drawnItems.clearLayers(); uploadedLayer.clearLayers(); trackLayer.setLatLngs([]); intersectLayer.clearLayers(); titularLabelsLayer.clearLayers();
    gpsVertices=[]; trackCoords=[]; activePolygon=null; lastTrackPoint=null; intersectFeatures=[]; inputPolygonFeature=null;
    if(gpsMarker){ map.removeLayer(gpsMarker); gpsMarker=null; } if(accuracyCircle){ map.removeLayer(accuracyCircle); accuracyCircle=null; }
    clearAllLabels(); infoPrecision.innerText='üì° Precisi√≥n: -- m'; localStorage.removeItem("bps_sesion");
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS'; }
    showStatus('üßπ Todo eliminado','#d9534f');
  };

  // ---------- AGREGAR V√âRTICE GPS ----------
  document.getElementById('btn-gps-vertex').onclick = () => {
    if(!gpsMarker) return alert('Activa el GPS primero.');
    const acc = gpsMarker.accuracy || 999;
    if(acc>7 && !confirm(`Precisi√≥n baja (${acc.toFixed(1)} m). ¬øAgregar v√©rtice igualmente?`)) return;
    const p = gpsMarker.getLatLng();
    gpsVertices.push([p.lat,p.lng]);
    L.circleMarker(p,{radius:5,color:'#0b6b2b',fillColor:'#0b6b2b',fillOpacity:1}).addTo(gpsLayer);
    if(!activePolygon && gpsVertices.length>=3){
      activePolygon = L.polygon(gpsVertices, { color:'#0b6b2b', fillOpacity:0.12 }).addTo(gpsLayer);
      addOrUpdateLabel(activePolygon);
      const coordsLonLat = gpsVertices.map(pp => [pp[1], pp[0]]);
      if(coordsLonLat[0][0] !== coordsLonLat[coordsLonLat.length-1][0] || coordsLonLat[0][1] !== coordsLonLat[coordsLonLat.length-1][1]) coordsLonLat.push(coordsLonLat[0]);
      inputPolygonFeature = { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[coordsLonLat] } };
      inputPolygonFeature.properties.area_ha = parseFloat((turf.area(inputPolygonFeature)/10000).toFixed(3));
      try { checkIntersection(inputPolygonFeature); } catch(e){}
    } else if(activePolygon){
      activePolygon.setLatLngs(gpsVertices);
      addOrUpdateLabel(activePolygon);
      const coordsLonLat = gpsVertices.map(pp => [pp[1], pp[0]]);
      if(coordsLonLat[0][0] !== coordsLonLat[coordsLonLat.length-1][0] || coordsLonLat[0][1] !== coordsLonLat[coordsLonLat.length-1][1]) coordsLonLat.push(coordsLonLat[0]);
      inputPolygonFeature = { type:'Feature', properties:{}, geometry:{ type:'Polygon', coordinates:[coordsLonLat] } };
      inputPolygonFeature.properties.area_ha = parseFloat((turf.area(inputPolygonFeature)/10000).toFixed(3));
      try { checkIntersection(inputPolygonFeature); } catch(e){}
    }
    saveSession();
  };

  // ---------- End ----------
  </script>
</body>
</html>
