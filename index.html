<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Predios Rurales + Titulares</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse para CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- TurfJS para intersecciÃ³n -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.6/turf.min.js"></script>

<style>
  #map {
    width: 100%;
    height: 92vh;
  }
  .label {
    background: white;
    padding: 2px 4px;
    border-radius: 3px;
    border: 1px solid #444;
    font-size: 12px;
  }
</style>
</head>

<body>
<h3 style="margin:4px">Catastro Rural + Titulares</h3>
<div id="map"></div>

<script>
// ---------------------------------------------------------------------------
// 1) Crear mapa
// ---------------------------------------------------------------------------
var map = L.map('map').setView([-6.5, -78.5], 9);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

// ---------------------------------------------------------------------------
// 2) Cargar CSV con titulares (cod_predio ; nombre)
// ---------------------------------------------------------------------------
let titulares = {};

Papa.parse("propietarios.csv", {
    download: true,
    header: true,
    delimiter: ";",
    complete: function(results) {
        results.data.forEach(row => {
            if (row.cod_predio) {
                titulares[row.cod_predio.trim()] = row.nombre ? row.nombre.trim() : "";
            }
        });
        console.log("TITULARES cargados:", titulares);
        cargarPrediosRurales();
    }
});

// ---------------------------------------------------------------------------
// 3) Cargar capa REST del MIDAGRI (Predios Rurales)
// ---------------------------------------------------------------------------
function cargarPrediosRurales() {

    fetch("https://georural.midagri.gob.pe/geoservicios/rest/services/public/Catastro_Rural/MapServer/0/query?where=1%3D1&outFields=*&f=geojson")
    .then(r => r.json())
    .then(predios => {

        // Unir CSV -> predios por cod_predio
        predios.features.forEach(f => {
            let cod = f.properties.cod_predio;
            if (titulares[cod]) {
                f.properties.titular = titulares[cod];
            } else {
                f.properties.titular = "(Sin titular)";
            }
        });

        // Crear capa Leaflet
        let prediosLayer = L.geoJSON(predios, {
            style: { color: "#ff7800", weight: 1 },
            onEachFeature: function (feature, layer) {
                // POPUP
                layer.bindPopup(
                    `<b>Cod_predio:</b> ${feature.properties.cod_predio}<br>
                     <b>Titular:</b> ${feature.properties.titular}`
                );
                // ETIQUETA
                layer.bindTooltip(
                    feature.properties.titular,
                    { permanent: true, direction: "center", className: "label" }
                );
            }
        }).addTo(map);

        console.log("Predios + titulares:", predios);
    });
}

</script>
</body>
</html>
