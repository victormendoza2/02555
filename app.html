<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>√Årea pol√≠gono desde Excel ‚Äì UTM</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse (CSV) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- Proj4 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { height: 90vh; }
  #panel {
    padding: 10px;
    background: #f4f4f4;
    border-bottom: 1px solid #ccc;
  }
</style>
</head>

<body>

<div id="panel">
  <input type="file" id="csvInput" accept=".csv">
  <span id="areaExcel" style="margin-left:20px;font-weight:bold;"></span>
</div>

<div id="map"></div>

<script>
/*****************************************************
 * MAPA
 *****************************************************/
const map = L.map('map').setView([-7.2, -78.5], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 22
}).addTo(map);

let polygonExcel = null;

/*****************************************************
 * FUNCIONES UTM (SOLO POL√çGONO EXCEL)
 *****************************************************/
function getUTMEPSGFromLonLat(lon, lat) {
  const zone = Math.floor((lon + 180) / 6) + 1;
  return lat < 0 ? `EPSG:327${zone}` : `EPSG:326${zone}`;
}

function calcularAreaPlanaUTM(geojson, epsgUTM) {
  const coords = geojson.geometry.coordinates[0];
  const projected = coords.map(c =>
    proj4('EPSG:4326', epsgUTM, c)
  );

  let area = 0;
  for (let i = 0; i < projected.length - 1; i++) {
    const [x1, y1] = projected[i];
    const [x2, y2] = projected[i + 1];
    area += (x1 * y2 - x2 * y1);
  }
  return Math.abs(area / 2); // m¬≤
}

function calcularAreaPoligonoExcel(polygonExcel) {
  const gj = polygonExcel.toGeoJSON();
  const [lon, lat] = gj.geometry.coordinates[0][0];
  const epsgUTM = getUTMEPSGFromLonLat(lon, lat);

  const area_m2 = calcularAreaPlanaUTM(gj, epsgUTM);
  const area_ha = (area_m2 / 10000).toFixed(3);

  document.getElementById('areaExcel').innerHTML =
    `√Årea pol√≠gono Excel (plana UTM): ${area_ha} ha`;

  return area_ha;
}

/*****************************************************
 * CARGA CSV
 * Formato esperado:
 * lon,lat
 *****************************************************/
document.getElementById('csvInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {

      const coords = results.data.map(r => [
        parseFloat(r.lon),
        parseFloat(r.lat)
      ]);

      if (coords.length < 3) {
        alert('El CSV debe tener al menos 3 v√©rtices');
        return;
      }

      // cerrar pol√≠gono si no est√° cerrado
      const first = coords[0];
      const last = coords[coords.length - 1];
      if (first[0] !== last[0] || first[1] !== last[1]) {
        coords.push(first);
      }

      if (polygonExcel) {
        map.removeLayer(polygonExcel);
      }

      polygonExcel = L.polygon(coords, {
        color: 'red',
        weight: 2,
        fillOpacity: 0.2
      }).addTo(map);

      map.fitBounds(polygonExcel.getBounds());

      // üëâ C√ÅLCULO DE √ÅREA SOLO AQU√ç
      calcularAreaPoligonoExcel(polygonExcel);
    }
  });
});
</script>

</body>
</html>

