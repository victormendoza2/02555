<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Registro Plantaciones Forestales BPS ‚Äî Con Titulares y Comunidades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Estilos originales preservados */
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    body { display:flex; }
    #panel { width: 360px; min-width: 300px; max-width: 420px; background: #f7f7f7; display:flex; flex-direction:column; border-right:1px solid #e6e6e6; padding-bottom:8px; box-sizing:border-box; }
    header { background: linear-gradient(90deg,#0b6b2b,#008000); color:white; padding:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    header h1 { margin:0; font-size:15px; }
    header p { margin:6px 0 0 0; font-size:12px; opacity:0.95; }
    .toolbar { display:flex; gap:6px; padding:10px; background:#fff; align-items:center; border-bottom:1px solid #e6e6e6; flex-wrap:wrap; }
    .toolbar button, .toolbar select { background:white; border:1px solid #d0d0d0; padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; gap:6px; align-items:center; font-size:13px; }
    .toolbar button.primary { background:#0b6b2b; color:white; border-color:#0b6b2b; }
    .controls { padding:10px; display:flex; flex-direction:column; gap:8px; }
    .infoBox { background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); font-size:13px; text-align:left; }
    .small { font-size:12px; color:#444; }
    #map { flex:1; height:100vh; }
    .label { background: rgba(255,255,255,0.95); padding:4px 6px; border-radius:6px; border:1px solid #ddd; font-size:12px; font-weight:600; }
    .etiqueta-predio { background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.45); padding: 2px 6px; font-size: 12px; font-weight: 600; border-radius: 4px; white-space: nowrap; pointer-events: none; }
    
    /* Nuevo estilo para los n√∫meros de los v√©rtices */
    .label-vertice {
      background: #e74c3c;
      color: white;
      border: 1px solid white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    #status-msg { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(11,107,43,0.95); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; opacity: 0; transition: opacity 0.35s; z-index: 9999; }
    #status-msg.show { opacity: 1; }
    table { width:100%; border-collapse:collapse; font-size:11px; }
    th, td { border:1px solid #e6e6e6; padding:6px; text-align:left; }
    th { background:#f0f0f0; }
  </style>
</head>
<body>

  <div id="panel">
    <header>
      <h1>üå≥ Registro Plantaciones Forestales BPS</h1>
      <p>Especialista en Gesti√≥n del Catastro Forestal - BPS</p>
    </header>

    <div class="toolbar">
      <button id="btn-gps"><i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS</button>
      <button id="btn-gps-vertex" class="primary"><i class="fa-solid fa-crosshairs"></i>&nbsp;V√©rtice GPS</button>
    </div>

    <div class="controls">
      <div class="infoBox">
        <div class="small">Cargar Excel / CSV con coordenadas</div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <input id="file-input" type="file" accept=".csv,.xlsx" style="display:none"/>
          <button id="btn-upload" style="width:100%;"><i class="fa-solid fa-file-import"></i>&nbsp;Cargar CSV / Excel</button>
        </div>

        <div style="display:flex;gap:6px;margin-top:8px;align-items:center;">
          <label class="small">CRS:</label>
          <select id="crs-select" style="flex:1;">
            <option value="4326">EPSG:4326 (Lat/Lon)</option>
            <option value="32717">EPSG:32717 (UTM 17S)</option>
            <option value="32718" selected>EPSG:32718 (UTM 18S)</option>
            <option value="32719">EPSG:32719 (UTM 19S)</option>
          </select>
        </div>

        <div style="margin-top:10px;display:flex;gap:6px;">
          <button id="btn-download-input-geo"><i class="fa-solid fa-download"></i>&nbsp;GeoJSON</button>
          <button id="btn-clear"><i class="fa-solid fa-trash"></i>&nbsp;Limpiar</button>
        </div>
        <div id="info-precision" class="small" style="margin-top:8px;">üì° Precisi√≥n: -- m</div>
      </div>

      <div class="infoBox">
        <div class="small"><b>MIDAGRI (Predio Rural)</b></div>
        <div style="display:flex;gap:6px;margin-top:5px;">
          <button id="btn-download-midagri-geo" style="flex:1;">GeoJSON</button>
          <button id="btn-download-midagri-csv" style="flex:1;">CSV</button>
        </div>
        <button id="btn-zoom-intersect" style="width:100%;margin-top:6px;"><i class="fa-solid fa-search-location"></i>&nbsp;Zoom</button>
      </div>

      <div id="results" class="infoBox" style="max-height:30vh; overflow-y:auto;">
        <div class="small"><b>Predios intersectados</b></div>
        <div id="tabla-inter" style="margin-top:8px;">No hay resultados.</div>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div id="status-msg"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>

  <script>
  // ---------- CONFIGURACI√ìN Y PROYECCIONES (Preservado de app.html) ----------
  function showStatus(msg, color="#0b6b2b"){
    const el = document.getElementById('status-msg');
    el.style.background = color; el.textContent = msg; el.classList.add('show');
    setTimeout(()=> el.classList.remove('show'), 2500);
  }

  proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32718","+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32719","+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs");

  const map = L.map('map', { zoomControl:true, maxZoom: 30}).setView([-7.2, -78.5], 8);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'});
  const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{attribution:'¬© Google'}).addTo(map);

  // --- NUEVA CAPA: COMUNIDADES CAMPESINAS MIDAGRI ---
  const comunidadesLayer = L.esri.featureLayer({
    url: 'https://georural.midagri.gob.pe/geoservicios/rest/services/public/Catastro_Rural/MapServer/1',
    style: { color: '#ff7800', weight: 2, fillOpacity: 0.3 }
  });

  // --- CAPAS DE TRABAJO ---
  const gpsLayer = new L.FeatureGroup().addTo(map);
  const uploadedLayer = new L.FeatureGroup().addTo(map);
  const drawnItems = new L.FeatureGroup().addTo(map);
  const trackLayer = L.polyline([], { color:'red', weight:3 }).addTo(map);
  const intersectLayer = new L.FeatureGroup().addTo(map);
  const labelLayer = new L.FeatureGroup().addTo(map);
  const verticesLayer = new L.FeatureGroup().addTo(map); // Capa para etiquetas V1, V2...

  // Selector de mapas corregido
  L.control.layers({"Google Sat√©lite":googleSat, "OSM":osm}, {
    "Comunidades (MIDAGRI)": comunidadesLayer,
    "V√©rtices (V1, V2...)": verticesLayer,
    "Predios Subidos": uploadedLayer,
    "Dibujos": drawnItems,
    "Intersecciones": intersectLayer
  }).addTo(map);

  let gpsMarker=null, accuracyCircle=null, watchId=null;
  let gpsVertices=[], trackCoords=[], propietariosMap={};
  let inputPolygonFeature = null, intersectFeatures = [];

  // --- FUNCI√ìN PARA ETIQUETAR V√âRTICES ---
  function dibujarVertices(layer) {
    verticesLayer.clearLayers();
    if (layer instanceof L.Polygon) {
      const coords = layer.getLatLngs()[0];
      if (!Array.isArray(coords)) return;
      coords.forEach((latlng, i) => {
        L.marker(latlng, {
          icon: L.divIcon({
            className: 'label-vertice',
            html: i + 1,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(verticesLayer);
      });
    }
  }

  // ---------- L√ìGICA DE DIBUJO ----------
  const drawControl = new L.Control.Draw({
    draw:{ polygon:{allowIntersection:false, showArea:true, shapeOptions:{color:'#0b6b2b'}}, marker:false, circle:false, rectangle:false, polyline:false },
    edit:{ featureGroup:drawnItems }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, e => {
    drawnItems.addLayer(e.layer);
    if(e.layer instanceof L.Polygon) {
      dibujarVertices(e.layer);
      addOrUpdateLabel(e.layer);
      checkIntersection(e.layer.toGeoJSON());
    }
    saveSession();
  });

  // ---------- C√ÅLCULOS DE √ÅREA Y UTM (Preservado de app.html) ----------
  function getUtmZone(lon) {
    if (lon >= -84 && lon < -80) return '32717';
    if (lon >= -80 && lon < -72) return '32718';
    if (lon >= -72 && lon < -68) return '32719';
    return '32718';
  }

  function calculatePlanarArea(geojson, target_crs_code = null) {
    if (!geojson || !geojson.geometry || geojson.geometry.type !== 'Polygon') return 0;
    let final_crs = target_crs_code;
    if (!final_crs || final_crs === '4326') {
      const centroid = turf.centroid(geojson).geometry.coordinates;
      final_crs = getUtmZone(centroid[0]);
    }
    if (final_crs.startsWith('327')) {
      let area = 0;
      const coords = geojson.geometry.coordinates[0];
      const projectedCoords = coords.map(c => {
        const p = proj4('EPSG:4326', 'EPSG:' + final_crs, [c[0], c[1]]);
        return { x: p[0], y: p[1] };
      });
      for (let i = 0, j = projectedCoords.length - 1; i < projectedCoords.length; j = i++) {
        area += (projectedCoords[j].x + projectedCoords[i].x) * (projectedCoords[j].y - projectedCoords[i].y);
      }
      return Math.abs(area / 2);
    }
    return turf.area(geojson);
  }

  function addOrUpdateLabel(layer){
    const area_m2 = calculatePlanarArea(layer.toGeoJSON());
    const area_ha = (area_m2/10000).toFixed(3);
    const center = turf.centerOfMass(layer.toGeoJSON()).geometry.coordinates;
    if(layer._label) map.removeLayer(layer._label);
    layer._label = L.marker([center[1], center[0]], { 
      icon: L.divIcon({ className:'label', html:`${area_ha} ha`}) 
    }).addTo(map);
  }

  // ---------- INTERSECCI√ìN Y MIDAGRI (Preservado y mejorado) ----------
  const midagriService = L.esri.featureLayer({ url: 'https://georural.midagri.gob.pe/geoservicios/rest/services/public/Catastro_Rural/MapServer/0' });

  function checkIntersection(geojson){
    document.getElementById('tabla-inter').innerHTML = "Consultando MIDAGRI...";
    midagriService.query().intersects(geojson).run((error, featureCollection) => {
      if(error || !featureCollection) return;
      intersectLayer.clearLayers();
      intersectFeatures = featureCollection.features;
      
      let html = "<table><tr><th>C√≥digo</th><th>Titular (CSV)</th><th>√Årea Ha</th></tr>";
      intersectFeatures.forEach(f => {
        L.geoJSON(f, { style:{color:'#00a94f', fillOpacity:0.3} }).addTo(intersectLayer);
        const cod = f.properties.cod_predio || f.properties.CU_PR || "S/C";
        const titular = propietariosMap[cod] || "No en CSV";
        const area = (f.properties.AREA / 10000 || 0).toFixed(3);
        html += `<tr><td>${cod}</td><td>${titular}</td><td>${area}</td></tr>`;
        
        // Etiqueta de titular en el mapa
        const cent = turf.centroid(f).geometry.coordinates;
        L.marker([cent[1], cent[0]], {
          icon: L.divIcon({ className:'etiqueta-predio', html: titular })
        }).addTo(labelLayer);
      });
      html += "</table>";
      document.getElementById('tabla-inter').innerHTML = intersectFeatures.length > 0 ? html : "Sin intersecci√≥n.";
    });
  }

  // ---------- GPS Y V√âRTICES (Preservado de app.html) ----------
  document.getElementById('btn-gps').onclick = () => {
    if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; showStatus('GPS Off','#d9534f'); return; }
    watchId = navigator.geolocation.watchPosition(p => {
      const lat=p.coords.latitude, lng=p.coords.longitude, acc=p.coords.accuracy;
      if(!gpsMarker) gpsMarker = L.circleMarker([lat,lng],{radius:7, color:'#2ecc71', fillOpacity:1}).addTo(map);
      gpsMarker.setLatLng([lat,lng]);
      gpsMarker.accuracy = acc;
      document.getElementById('info-precision').innerText = `üì° Precisi√≥n: ${acc.toFixed(1)} m`;
    }, null, {enableHighAccuracy:true});
    showStatus('GPS On');
  };

  document.getElementById('btn-gps-vertex').onclick = () => {
    if(!gpsMarker) return alert("Active el GPS");
    const p = gpsMarker.getLatLng();
    gpsVertices.push([p.lat, p.lng]);
    L.circleMarker(p, {radius:4, color:'#0b6b2b'}).addTo(gpsLayer);
    
    if(gpsVertices.length >= 3){
      const poly = L.polygon(gpsVertices, {color:'#0b6b2b'}).addTo(gpsLayer);
      dibujarVertices(poly);
      addOrUpdateLabel(poly);
      inputPolygonFeature = poly.toGeoJSON();
      checkIntersection(inputPolygonFeature);
    }
  };

  // ---------- CARGA DE ARCHIVOS (Preservado de propietarios.csv y app.html) ----------
  document.getElementById('btn-upload').onclick = () => document.getElementById('file-input').click();
  document.getElementById('file-input').onchange = e => {
    const file = e.target.files[0];
    if(file.name.includes('propietarios')) {
      Papa.parse(file, { header:true, skipEmptyLines:true, complete: r => {
        r.data.forEach(row => { 
          const cod = (row.cod_predio || "").trim();
          if(cod) propietariosMap[cod] = row.nombre || "SIN NOMBRE";
        });
        showStatus("‚úÖ Propietarios cargados");
      }});
    } else {
      // Aqu√≠ se activar√≠a tu l√≥gica de parseCSV / parseXLSX original
      showStatus("Cargando pol√≠gono...");
      // (L√≥gica simplificada para el ejemplo, pero usa tus funciones parse originales)
    }
  };

  // ---------- LIMPIEZA Y SESI√ìN ----------
  document.getElementById('btn-clear').onclick = () => {
    if(confirm('¬øLimpiar todo?')){
      gpsLayer.clearLayers(); drawnItems.clearLayers(); uploadedLayer.clearLayers(); 
      intersectLayer.clearLayers(); labelLayer.clearLayers(); verticesLayer.clearLayers();
      gpsVertices = [];
      showStatus('Mapa Limpio','#d9534f');
    }
  };

  function saveSession(){
    const data = { drawn: drawnItems.toGeoJSON(), gps: gpsLayer.toGeoJSON() };
    localStorage.setItem("bps_sesion", JSON.stringify(data));
  }

  window.onload = () => {
    const saved = localStorage.getItem("bps_sesion");
    if(saved && confirm("¬øRestaurar sesi√≥n?")){
      L.geoJSON(JSON.parse(saved).drawn, { onEachFeature:(f,l)=>{ drawnItems.addLayer(l); addOrUpdateLabel(l); }});
    }
    // Carga autom√°tica si existe el archivo en la carpeta
    fetch('propietarios.csv').then(r => r.text()).then(t => {
      Papa.parse(t, {header:true, complete: r => {
        r.data.forEach(row => { if(row.cod_predio) propietariosMap[row.cod_predio.trim()] = row.nombre; });
      }});
    }).catch(() => console.log("Suba el CSV manualmente"));
  };
  </script>
</body>
</html>
